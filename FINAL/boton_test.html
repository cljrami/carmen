<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Sist√©mico</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Lora:wght@400;700&family=Montserrat:wght@400;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Estilos sin cambios */
      .test-launcher-button {
        font-family: "Lora", serif;
        font-weight: bold;
        font-size: 1.1em;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: inline-block;
        padding: 16px 38px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin: 10px;
      }
      .test-launcher-button:hover {
        transform: scale(1.02);
      }
      .test-launcher-button.variant-pink {
        background: linear-gradient(45deg, #e6007e, #c4006c);
        color: white;
      }
      .popup-overlay,
      .popup-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgb(105 44 145 / 72%);
        backdrop-filter: blur(5px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        font-family: "Lora", serif;
      }
      .quiz-container {
        position: relative;
        max-width: 500px;
        margin: 0 16px;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        padding: 48px 24px 24px;
        animation: fadeInQuiz 1s;
        overflow: auto;
        max-height: 90vh;
      }
      @keyframes fadeInQuiz {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .quiz-header h1 {
        margin: 0;
        font-size: 1.8em;
        font-family: "Lora", serif;
        color: #692c91;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #333;
        border-radius: 4px;
        margin: 24px 0;
        overflow: hidden;
      }
      .progress {
        height: 100%;
        background: linear-gradient(90deg, #ff512f, #dd2476);
        width: 0;
        transition: width 0.4s cubic-bezier(0.4, 2, 0.6, 1);
      }
      .question-section p {
        font-size: 1.2rem;
        line-height: 1.5;
        color: #000;
        font-weight: normal;
      }
      .answers {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .input-field {
        color: #000;
        border: 2px solid #67358e;
        border-radius: 8px;
        padding: 14px 10px;
        font-size: 1.1em;
        width: 100%;
        transition: all 0.2s;
        font-family: "Lora", serif;
        box-sizing: border-box;
      }
      .input-field:focus {
        outline: none;
        border-color: #ff512f;
      }
      .answer-btn {
        background: #692c91;
        color: #fff;
        border: 2px solid #ff512f;
        border-radius: 8px;
        padding: 14px 10px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.2s;
        font-family: "Lora", serif;
        width: 100%;
        text-align: center;
      }
      .answer-btn:hover,
      .answer-btn.selected {
        background: #ff512f;
        border-color: #fff;
      }
      .nav-btns {
        display: flex;
        justify-content: space-between;
        margin-top: 18px;
      }
      .nav-btn {
        background: #67358e;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 28px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background 0.2s;
        font-family: "Lora", serif;
      }
      .nav-btn:disabled {
        background: #555;
        cursor: not-allowed;
      }
      .popup-step {
        display: none;
        text-align: center;
        margin: 0 16px;
        max-width: 500px;
        width: 90%;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        padding: 48px 24px 24px;
        animation: fadeInQuiz 1s;
        overflow: auto;
        max-height: 90vh;
        position: relative;
        color: #000;
      }
      .popup-step.active {
        display: block;
      }
      .completion-message {
        text-align: center;
        padding: 30px 20px;
      }
      .completion-message h2 {
        font-family: "Lora", serif;
        color: #67358e;
        font-size: 1.5em;
        font-weight: 700;
      }
      .redirect-btn {
        background: linear-gradient(90deg, #ff512f, #dd2476);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 15px 30px;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.2s;
        margin: 20px 10px;
        font-weight: bold;
      }
      .redirect-btn:disabled {
        background: #555;
        cursor: not-allowed;
      }
      .section-title {
        color: #ff512f;
        font-size: 1.2em;
        text-align: center;
        margin-top: 10px;
        margin-bottom: 20px;
        font-weight: bold;
        font-family: "Lora", serif;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center; padding: 40px">
      <button
        class="test-launcher-button variant-pink"
        onclick="openIntroPopup()"
      >
        ‚ú® Haz el Test Sist√©mico Gratuito
      </button>
    </div>

    <div class="popup-container" id="popupContainer">
      <div class="popup-step active" id="popupStep1">
        <h2>üåø Este no es un test cualquiera.</h2>
        <p>
          Es una herramienta terap√©utica que puede ayudarte a descubrir por qu√©
          el amor, el dinero o tu paz interior parecen escaparse.
        </p>
        <p style="margin-top: 15px">¬øCu√°l es tu nombre completo?</p>
        <input
          type="text"
          id="introName"
          class="input-field"
          placeholder="Tu nombre completo"
          oninput="updateIntroButtonState(1)"
        />
        <button
          class="nav-btn"
          id="introNextBtn1"
          onclick="showNextPopup()"
          disabled
        >
          Siguiente
        </button>
      </div>
      <div class="popup-step" id="popupStep2">
        <h2>¬øC√≥mo funciona?</h2>
        <p>
          Cada pregunta ha sido construida desde el enfoque de las
          Constelaciones Familiares. Responde con consciencia para recibir una
          mejor lectura.
        </p>
        <p style="margin-top: 15px">¬øCu√°l es tu correo electr√≥nico favorito?</p>
        <input
          type="email"
          id="introEmail"
          class="input-field"
          placeholder="Tu correo electr√≥nico"
          oninput="updateIntroButtonState(2)"
        />
        <button
          class="nav-btn"
          id="introNextBtn2"
          onclick="showNextPopup()"
          disabled
        >
          Siguiente
        </button>
      </div>
      <div class="popup-step" id="popupStep3">
        <h2>Antes de comenzar</h2>
        <p>üßò‚Äç‚ôÄÔ∏è Respira. Este momento es solo para ti. T√≥mate tu tiempo.</p>
        <p>
          üí¨ ‚ÄúLo que no se nombra‚Ä¶ se repite. Pero lo que se comprende, se
          transforma.‚Äù
        </p>
        <p style="margin-top: 15px">¬øCu√°l es tu Edad?</p>
        <input
          type="number"
          id="introAge"
          class="input-field"
          placeholder="Tu edad"
          oninput="updateIntroButtonState(3)"
        />
        <button
          class="nav-btn"
          id="startQuizBtn"
          onclick="startQuizFromIntro()"
          disabled
        >
          Empezar el test ahora
        </button>
      </div>
    </div>
    <div class="popup-overlay" id="popupQuizOverlay">
      <div class="quiz-container" id="popupQuizContainer"></div>
    </div>

    <script>
      let currentPopup = 1,
        totalPopups = 3,
        introData = {},
        current = 0,
        answers = {};
      const quiz = [
        {
          id: "tiene_pareja",
          section: "üë§ RELACIONES PERSONALES",
          question: "¬øActualmente tienes una relaci√≥n de pareja?",
          type: "radio",
          options: ["S√≠", "No"],
        },
        {
          id: "tiene_hijos",
          section: "üë§ RELACIONES PERSONALES",
          question: "¬øTienes hijos? ¬øQu√© edades tienen?",
          type: "text",
        },
        {
          id: "relacion_madre",
          section: "üå≥ HABLEMOS DE TU SISTEMA FAMILIAR",
          question: "¬øC√≥mo describir√≠as tu relaci√≥n con tu madre?",
          type: "text",
        },
        {
          id: "relacion_padre",
          section: "üå≥ HABLEMOS DE TU SISTEMA FAMILIAR",
          question: "¬øC√≥mo describir√≠as tu relaci√≥n con tu padre?",
          type: "text",
        },
        {
          id: "separacion_dificil",
          section: "üå≥ HABLEMOS DE TU SISTEMA FAMILIAR",
          question:
            "¬øHubo alguna separaci√≥n dif√≠cil que marc√≥ a tu familia (divorcio, fallecimiento, abandono)? ¬øQu√© edad ten√≠as?",
          type: "text",
        },
        {
          id: "situaciones_dificiles",
          section: "üå≥ HABLEMOS DE TU SISTEMA FAMILIAR",
          question:
            "¬øQu√© situaciones dif√≠ciles han marcado a tu familia? (Ej.: infidelidades, abortos, adicciones, enfermedades, abusos, etc.)",
          type: "text",
        },
        {
          id: "ambiente_infancia",
          section: "üå≥ HABLEMOS DE TU SISTEMA FAMILIAR",
          question:
            "¬øC√≥mo recuerdas el ambiente en tu hogar durante tu infancia?",
          type: "text",
        },
        {
          id: "familiar_dolor",
          section: "üå≥ HABLEMOS DE TU SISTEMA FAMILIAR",
          question:
            "¬øHay alguien en tu familia que ha vivido m√°s dolor o exclusi√≥n que los dem√°s? ¬øQu√© ha pasado con esa persona?",
          type: "text",
        },
        {
          id: "familiar_admirado",
          section: "üå≥ HABLEMOS DE TU SISTEMA FAMILIAR",
          question:
            "¬øHay alguien en tu familia a quienes todos admiran? ¬øPor qu√©?",
          type: "text",
        },
        {
          id: "situaciones_repetitivas",
          section: "üîÅ DIN√ÅMICAS Y PATRONES REPETITIVOS",
          question: "¬øQu√© situaciones has notado que se repiten en tu familia?",
          type: "text",
        },
        {
          id: "rol_familiar",
          section: "üîÅ DIN√ÅMICAS Y PATRONES REPETITIVOS",
          question:
            "¬øHas sentido que ocupas un rol diferente al que te corresponde en tu familia?",
          type: "text",
        },
        {
          id: "propension_dar_recibir",
          section: "üîÅ DIN√ÅMICAS Y PATRONES REPETITIVOS",
          question: "¬øEres m√°s propenso/a a dar o a recibir en tus relaciones?",
          type: "radio",
          options: ["Dar", "Recibir"],
        },
        {
          id: "patron_sentimental",
          section: "üíî RELACIONES DE PAREJA",
          question: "¬øQu√© patr√≥n identificas en tus relaciones sentimentales?",
          type: "text",
        },
        {
          id: "creencias_amor",
          section: "üíî RELACIONES DE PAREJA",
          question: "¬øQu√© creencias aprendiste sobre el amor en tu infancia?",
          type: "text",
        },
        {
          id: "relacion_padres_dinero",
          section: "üí∞ RELACI√ìN CON EL DINERO",
          question: "¬øC√≥mo era la relaci√≥n de tus padres con el dinero?",
          type: "text",
        },
        {
          id: "frases_dinero",
          section: "üí∞ RELACI√ìN CON EL DINERO",
          question: "¬øQu√© frases familiares recuerdas sobre el dinero?",
          type: "text",
        },
        {
          id: "emocion_mas_dinero_padres",
          section: "üí∞ RELACI√ìN CON EL DINERO",
          question:
            "¬øQu√© emociones sientes al pensar en tener m√°s dinero que tus padres?",
          type: "text",
        },
        {
          id: "familiar_excluido_dinero",
          section: "üí∞ RELACI√ìN CON EL DINERO",
          question:
            "¬øQui√©n en tu familia fue rechazado por tener mucho o poco dinero?",
          type: "text",
        },
        {
          id: "comparacion_familiar_exito",
          section: "üí∞ RELACI√ìN CON EL DINERO",
          question:
            "¬øSientes que nunca ser√°s tan bueno/a o exitoso/a como cierto familiar?",
          type: "text",
        },
        {
          id: "sintoma_fisico",
          section: "üß† CUERPO Y EMOCI√ìN",
          question:
            "¬øSufres de alg√∫n s√≠ntoma f√≠sico o problema de salud recurrente?",
          type: "text",
        },
        {
          id: "emocion_frecuente",
          section: "üß† CUERPO Y EMOCI√ìN",
          question:
            "¬øQu√© emoci√≥n sientes con mayor frecuencia en tu d√≠a a d√≠a?",
          type: "text",
        },
        {
          id: "anhelo_sanar",
          section: "‚ú® TU MOMENTO ACTUAL",
          question:
            "¬øQu√© es lo que m√°s anhelas sanar o transformar en tu vida?",
          type: "text",
        },
      ];

      function openIntroPopup() {
        document.getElementById("popupContainer").style.display = "flex";
        document.getElementById("popupStep1").classList.add("active");
        for (let i = 2; i <= totalPopups; i++) {
          document.getElementById(`popupStep${i}`).classList.remove("active");
        }
        currentPopup = 1;
        introData = {};
        document.getElementById("introName").value = "";
        document.getElementById("introEmail").value = "";
        document.getElementById("introAge").value = "";
        updateIntroButtonState(1);
        updateIntroButtonState(2);
        updateIntroButtonState(3);
      }

      function updateIntroButtonState(step) {
        if (step === 1) {
          document.getElementById("introNextBtn1").disabled =
            document.getElementById("introName").value.trim() === "";
        } else if (step === 2) {
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          document.getElementById("introNextBtn2").disabled =
            !emailPattern.test(document.getElementById("introEmail").value);
        } else if (step === 3) {
          const ageInput = document.getElementById("introAge");
          document.getElementById("startQuizBtn").disabled =
            ageInput.value.trim() === "" ||
            isNaN(ageInput.value) ||
            parseInt(ageInput.value) <= 0;
        }
      }

      function showNextPopup() {
        if (currentPopup === 1)
          introData.nombre_completo =
            document.getElementById("introName").value;
        if (currentPopup === 2)
          introData.email = document.getElementById("introEmail").value;
        document
          .getElementById(`popupStep${currentPopup}`)
          .classList.remove("active");
        currentPopup++;
        const nextStep = document.getElementById(`popupStep${currentPopup}`);
        if (nextStep) nextStep.classList.add("active");
      }

      function startQuizFromIntro() {
        introData.edad = document.getElementById("introAge").value;
        answers = { ...introData };
        document.getElementById("popupContainer").style.display = "none";
        document.getElementById("popupQuizOverlay").style.display = "flex";
        current = 0;
        renderQuiz();
      }

      function renderQuiz() {
        const container = document.getElementById("popupQuizContainer");
        if (current >= quiz.length) {
          container.innerHTML = `<div class="completion-message"><h2>¬°Gracias por tu honestidad!</h2><p>Est√°s a un solo paso de ver tu an√°lisis sist√©mico personalizado.</p><div style="margin-top: 30px;"><button class="redirect-btn" id="finalSubmitBtn" onclick="saveAndRedirect()">‚ú® Ver mi resultado ahora</button></div></div>`;
          return;
        }
        const q = quiz[current];
        const progress = Math.round(((current + 1) / quiz.length) * 100);
        let sectionTitle =
          current === 0 || quiz[current].section !== quiz[current - 1].section
            ? `<div class="section-title">${q.section}</div>`
            : "";
        let optionsHTML = "";
        if (q.type === "radio") {
          optionsHTML = q.options
            .map(
              (opt) =>
                `<button class="answer-btn ${
                  answers[q.id] === opt ? "selected" : ""
                }" onclick="selectAnswer('${q.id}', '${opt}')">${opt}</button>`
            )
            .join("");
        } else {
          optionsHTML = `<textarea class="input-field" rows="4" oninput="updateQuizButtonState()" placeholder="Escribe tu respuesta...">${
            answers[q.id] || ""
          }</textarea>`;
        }
        container.innerHTML = `<div class="quiz-header"><h1>Test Sist√©mico</h1></div><div class="progress-bar"><div class="progress" style="width:${progress}%"></div></div>${sectionTitle}<div class="question-section"><p>${
          q.question
        }</p></div><div class="answers">${optionsHTML}</div><div class="nav-btns"><button class="nav-btn" onclick="prevStep()" ${
          current === 0 ? "disabled" : ""
        }>Anterior</button><button class="nav-btn" onclick="nextStep()" id="nextBtn" disabled>Siguiente</button></div><div style="text-align:center; margin-top:10px; font-size:0.9em; color:#aaa;">Pregunta ${
          current + 1
        } de ${quiz.length}</div>`;
        updateQuizButtonState();
      }

      function updateQuizButtonState() {
        if (current >= quiz.length) return;
        const q = quiz[current];
        let isAnswered = false;
        if (q.type === "text") {
          const input = document.querySelector(
            "#popupQuizContainer .input-field"
          );
          if (input && input.value.trim() !== "") {
            answers[q.id] = input.value;
            isAnswered = true;
          }
        } else {
          if (answers[q.id] !== undefined && answers[q.id] !== "") {
            isAnswered = true;
          }
        }
        const nextButton = document.getElementById("nextBtn");
        if (nextButton) nextButton.disabled = !isAnswered;
      }

      function selectAnswer(questionId, answer) {
        answers[questionId] = answer;
        nextStep();
      }

      function nextStep() {
        const q = quiz[current];
        if (q.type === "text") {
          const input = document.querySelector(
            "#popupQuizContainer .input-field"
          );
          if (input) answers[q.id] = input.value;
        }
        if (current < quiz.length) {
          current++;
          renderQuiz();
        }
      }

      function prevStep() {
        if (current > 0) {
          current--;
          renderQuiz();
        }
      }

      function saveAndRedirect() {
        const button = document.getElementById("finalSubmitBtn");
        if (button) {
          button.innerHTML = "Redirigiendo...";
          button.disabled = true;
        }
        const finalAnswers = { ...answers };
        quiz.forEach((q) => {
          finalAnswers[q.id] = finalAnswers[q.id] || "No respondido";
        });
        finalAnswers.timestamp = new Date().toISOString();
        sessionStorage.setItem(
          "systemicTestAnswers",
          JSON.stringify(finalAnswers)
        );
        // IMPORTANTE: Aseg√∫rate de que esta URL sea la correcta de tu p√°gina de 'thanks.html'
        window.location.href =
          "https://app.gohighlevel.com/v2/preview/HKnPWW8f9mwmSknJEGuG";
      }
    </script>
  </body>
</html>
